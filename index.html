<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>MultiTwitch Viewer</title>
<style>
  body {
    background-color: #121212;
    color: #fff;
    font-family: sans-serif;
    margin: 0;
    display: flex;
    flex-direction: row;
    height: 100vh;
    overflow: hidden;
  }
  #sidebar {
    display: flex;
    flex-direction: column;
    position: relative;
    height: 100vh;
    min-height: 0;
  }
  /* Add padding to the stream list container */
  #streamList {
    flex: 1 1 auto;
    overflow-y: auto;
    min-height: 0;
    max-height: 100vh;
    /* keep your padding here */
  }
  #container {
    flex: 1 1 0;
    min-width: 0;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-content: flex-start;
    justify-content: flex-start; /* Prevents stretching to fill row */
    background: #181818;
    border-right: 2px solid #333;
    padding: 0;
    overflow-y: auto;
    max-height: 100vh;
    position: relative;
  }
  #chat {
    display: none;
    flex-direction: column;
    width: 260px;
    min-width: 0;
    background: #1e1e1e;
    height: 100vh;
    max-height: 100vh;
    box-sizing: border-box;
    min-height: 0;
    overflow: hidden;
  }
  #chat-header {
    flex: 0 0 auto;
    font-weight: bold;
    font-size: 1.2em;
    text-align: center;
    color: #bbb;
    letter-spacing: 1px;
    background: #222;
    padding: 12px 0 10px 0;
    border-bottom: 2px solid #333;
    border-radius: 6px 6px 0 0;
    box-shadow: 0 2px 6px #0002;
    margin-bottom: 0;
  }
  #chat-content {
    flex: 1 1 auto;
    min-height: 0 !important;
    height: 100%;
    display: flex;
    flex-direction: column;
    margin: 0;
    padding: 0;
    overflow: hidden;
  }
  #chat-content iframe {
    flex: 1 1 auto;
    min-height: 0 !important;
    width: 100%;
    height: 100%;
    border: none;
    display: block;
    overflow: auto;
  }
  .stream-wrapper {
    background: #000;
    flex: 0 1 450px;         /* Don't grow, shrink if needed, base width 450px */
    min-width: 320px;
    max-width: 450px;        /* Prevent stretching beyond 450px */
    aspect-ratio: 16 / 9;
    height: auto;
    border: 2px solid #333;
    border-radius: 12px;
    display: flex;
    align-items: stretch;
    justify-content: center;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(.4,2,.6,1);
    cursor: pointer;
    box-sizing: border-box;
    padding: 0;
    position: relative;
    margin: 0 0 10px 0;      /* Add some vertical spacing between rows */
  }
  .stream-wrapper.focused {
    border: 3px solid #9147ff;
    box-shadow: 0 0 24px #000a;
    flex: 1 1 100%;
    max-width: 100%;
    min-width: 0;
    width: 100%;
    z-index: 10;
    background: #181818;
    transition: all 0.3s cubic-bezier(.4,2,.6,1);
    order: 0; /* Always first in flex order */
    aspect-ratio: 16 / 9;
    max-height: 60vh; /* or adjust as you like */
    height: auto;
  }
  .stream-wrapper.single {
    flex: 1 1 100%;
    max-width: 100%;
    min-width: 0;
    aspect-ratio: unset;
    height: 100%;
  }
  .stream-wrapper iframe,
  .stream-wrapper > div {
    width: 100%;
    height: 100%;
    aspect-ratio: 16 / 9;
    border: none;
    display: block;
  }
  .stream-wrapper.focused iframe,
  .stream-wrapper.focused > div {
    width: 100%;
    height: 100%;
    aspect-ratio: 16 / 9;
    border: none;
    display: block;
    object-fit: cover; /* This helps fill the space */
    background: #000;
  }
  .stream-wrapper iframe {
    object-fit: contain;
    background: #000;
  }
  .stream-wrapper.youtube-stream iframe {
  width: 100%;
  height: 100%;
  aspect-ratio: 16/9;
  object-fit: contain;
  border: none;
  background: #000;
  display: block;
}
  .stream-wrapper.focused.kick-stream {
    aspect-ratio: 16 / 9 !important;
    height: auto !important;
    max-height: 60vh;
    width: 100%;
    background: #000;
    display: flex;
    align-items: stretch;
    justify-content: center;
    overflow: hidden;
  }

  .stream-wrapper.focused.kick-stream iframe {
    width: 100% !important;
    height: 100% !important;
    aspect-ratio: 16 / 9 !important;
    object-fit: contain !important;
    background: #000;
    display: block;
    padding: 0 !important;
    border: none;
  }
  .stream-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 0;
    border-bottom: 1px solid #222;
    font-size: 1em;
  }
  /* Add left padding to each stream item for extra space */
  .stream-item {
    padding-left: 6px;
  }
  .stream-item:last-child {
    border-bottom: none;
  }
  .stream-item span {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 8px;
    word-break: break-all;
  }
  .stream-item button {
    cursor: pointer;
    background: #333;
    border: none;
    color: #fff;
    padding: 2px 5px;
    border-radius: 4px;
  }
  .stream-item button:hover {
    background: #555;
  }
  .stream-item button.active {
    background: #9147ff;
  }
  #controls {
    margin-bottom: 10px;
  }
  #addForm {
    display: flex;
    gap: 5px;
    margin-bottom: 10px;
  }
  #addForm input, #addForm select {
    padding: 5px;
    box-sizing: border-box;
    border-radius: 4px;
    border: none;
  }
  #channelInput {
    flex: 2;
    min-width: 0;
  }
  #platformSelect {
    flex: 1;
    min-width: 90px;
  }
  #addBtn {
    flex: 0;
    background: #333;
    color: #fff;
    border: none;
    border-radius: 4px;
    padding: 5px 10px;
    cursor: pointer;
  }
  #addBtn:hover {
    background: #555;
  }
  #resetBtn {
    background: #ff4c4c;
    color: #fff;
    border: none;
    padding: 5px;
    cursor: pointer;
    border-radius: 4px;
    width: 100%;
  }
  #resetBtn:hover {
    background: #e03a3a;
  }
  #settings-btn {
    margin: 0;
    width: auto;
    box-shadow: 0 2px 8px #0004;
    display: flex;
    align-items: center;
    justify-content: center;
    background: none;
    border-radius: 8px;
    padding: 4px 10px;
  }
  #settings-btn:hover {
    background: #333;
  }
  #settings-footer {
    flex: 0 0 auto;
    padding: 18px 0 14px 0;
    background: linear-gradient(90deg, #232323 60%, #181818 100%);
    border-top: 2px solid #9147ff; /* Twitch purple accent */
    box-shadow: 0 -2px 12px #0006;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .settings-label {
    color: #ffb300; /* Gold accent for label */
    font-size: 1.08em;
    font-weight: 600;
    letter-spacing: 0.5px;
    padding-left: 2px;
    padding-right: 2px;
    user-select: none;
  }
  #settings-btn svg {
    min-width: 28px;
    min-height: 28px;
    max-width: 28px;
    max-height: 28px;
    margin-right: 2px;
  }
  #settings-modal {
    display: none;
    position: fixed;
    left: 0;
    top: 0;
    width: 100vw;
    height: 100vh;
    background: #000a;
    z-index: 200;
    align-items: center;
    justify-content: center;
  }
  #settings-modal > div {
    background: #222;
    color: #fff;
    padding: 32px 24px 24px 24px;
    border-radius: 12px;
    min-width: 300px;
    max-width: 90vw;
    box-shadow: 0 4px 32px #000a;
    position: relative;
  }
  #close-settings {
    position: absolute;
    top: 10px;
    right: 14px;
    background: none;
    border: none;
    color: #fff;
    font-size: 1.5em;
    cursor: pointer;
  }
  #resetBtn {
    background: #ff4c4c;
    color: #fff;
    border: none;
    padding: 7px 18px;
    cursor: pointer;
    border-radius: 4px;
    font-size: 1em;
    margin-top: 10px;
    width: 100%;
  }
  #settings-footer {
    flex: 0 0 auto;
    padding: 16px 0 10px 0;
    background: #1e1e1e;
    z-index: 10;
    margin-bottom: 0;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .focus-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 5;
    background: #222;
    color: #fff;
    border: 2px solid #9147ff;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    font-size: 1.2em;
    cursor: pointer;
    opacity: 0.85;
    transition: background 0.2s, border 0.2s, opacity 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
  }
  .focus-btn:hover {
    background: #9147ff;
    color: #fff;
    border-color: #fff;
    opacity: 1;
  }
  #empty-placeholder {
    position: absolute;
    left: 260px;
    right: 0;
    top: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #bbb;
    font-size: 1.5em;
    pointer-events: none;
    z-index: 1;
    background: transparent;
  }
  .folder {
    margin-bottom: 10px;
    background: #181818;
    border-radius: 6px;
    overflow: hidden;
  }
  .folder-header {
    font-weight: bold;
    padding: 8px 12px;
    background: #232323;
    cursor: pointer;
    user-select: none;
    color: #fff;
    border-bottom: 1px solid #222;
  }
  .folder-content {
    padding: 0 0 0 0;
    display: block;
  }
  #rotation-warning {
  display: block;
  position: fixed;
  left: 50%;
  bottom: 18px;
  transform: translateX(-50%);
  background: #222;
  color: #ffb300;
  padding: 4px 14px;
  border-radius: 12px;
  font-size: 0.98em;
  box-shadow: 0 2px 12px #000a;
  z-index: 300;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.7s;
  max-width: 90vw;
  white-space: nowrap;
}
#rotation-warning.visible {
  opacity: 0.92;
}

/* For Webkit browsers (Chrome, Edge, Safari, Opera) */
::-webkit-scrollbar {
  width: 12px;
  background: #181818; /* Dark background */
}
::-webkit-scrollbar-thumb {
  background: #2962ff; /* Blue slider */
  border-radius: 8px;
  border: 2px solid #181818;
}
::-webkit-scrollbar-thumb:hover {
  background: #448aff; /* Lighter blue on hover */
}

/* For Firefox */
* {
  scrollbar-width: thin;
  scrollbar-color: #2962ff #181818;
}

#app-header {
  user-select: none;
  font-family: inherit;
}
#app-header svg {
  display: block;
}
</style>
</head>
<body>
  <div id="sidebar">
  <div id="app-header" style="display:flex;align-items:center;gap:10px;padding:18px 0 10px 18px;">
    <!-- Phoenix/Bird SVG Logo -->
    <svg width="32" height="32" viewBox="0 0 64 64" fill="none">
      <defs>
        <linearGradient id="phoenix-gradient" x1="0" y1="0" x2="64" y2="64" gradientUnits="userSpaceOnUse">
          <stop stop-color="#ffb300"/>
          <stop offset="1" stop-color="#9147ff"/>
        </linearGradient>
      </defs>
      <!-- Body/Wing -->
      <path d="M32 56
               Q44 44 40 28
               Q52 36 56 16
               Q46 28 38 18
               Q44 10 32 8
               Q20 10 26 18
               Q18 28 8 16
               Q12 36 24 28
               Q20 44 32 56Z"
            fill="url(#phoenix-gradient)" stroke="#ffb300" stroke-width="2"/>
      <!-- Head/Beak -->
      <circle cx="32" cy="16" r="4" fill="#ffb300" stroke="#9147ff" stroke-width="1.5"/>
      <polygon points="36,15 41,13 36,17" fill="#ffb300"/>
    </svg>
    <span style="font-size:1.4em;font-weight:bold;letter-spacing:1px;color:#ffb300;">MultiStream Hub</span>
  </div>
    <div id="controls">
      <form id="addForm">
        <input type="text" id="channelInput" placeholder="Streamer/Channel/Video ID or URL" autocomplete="off" />
        <select id="platformSelect">
          <option value="twitch">Twitch</option>
          <option value="kick">Kick</option>
          <option value="youtube">YouTube</option>
        </select>
        <button type="submit" id="addBtn">Add</button>
      </form>
    </div>
    <div id="streamList">
      <div class="folder" id="folder-current">
        <div class="folder-header" onclick="toggleFolder('current')">Currently Watching (0 streams) ▼</div>
        <div class="folder-content" id="folder-content-current"></div>
      </div>
      <div class="folder" id="folder-youtube">
        <div class="folder-header" onclick="toggleFolder('youtube')">YouTube (0 streams) ▼</div>
        <div class="folder-content" id="folder-content-youtube"></div>
      </div>
      <div class="folder" id="folder-kick">
        <div class="folder-header" onclick="toggleFolder('kick')">Kick (0 streams) ▼</div>
        <div class="folder-content" id="folder-content-kick"></div>
      </div>
      <div class="folder" id="folder-twitch">
        <div class="folder-header" onclick="toggleFolder('twitch')">Twitch (0 streams) ▼</div>
        <div class="folder-content" id="folder-content-twitch"></div>
      </div>
    </div>
    <div id="settings-footer">
      <div id="settings-btn" title="Settings">
        <span style="display:flex; align-items:center; gap:8px;">
          <svg width="28" height="28" viewBox="0 0 28 28" fill="none" style="display:block;">
            <circle cx="14" cy="14" r="12" stroke="#bbb" stroke-width="2.2" fill="#222"/>
            <g stroke="#bbb" stroke-width="2">
              <circle cx="14" cy="14" r="4"/>
              <path d="M14 4v3M14 21v3M4 14h3M21 14h3M7.2 7.2l2.1 2.1M18.7 18.7l2.1 2.1M7.2 20.8l2.1-2.1M18.7 9.3l2.1-2.1"/>
            </g>
          </svg>
          <span class="settings-label">Settings</span>
        </span>
      </div>
    </div>
  </div>

  <div id="rotation-warning">
    Non-focused streams are being rotated every 5 minutes.
  </div>
  <div id="container"></div>
  <div id="empty-placeholder">
    Add a channel or YouTube video ID to get started.
  </div>

  <div id="chat">
    <div id="chat-header">Chatbox</div>
    <div id="chat-content"></div>
  </div>

  <div id="settings-modal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:#000a; z-index:200; align-items:center; justify-content:center;">
    <div style="background:#222; color:#fff; padding:32px 24px 24px 24px; border-radius:12px; min-width:300px; max-width:90vw; box-shadow:0 4px 32px #000a; position:relative;">
      <button id="close-settings" style="position:absolute; top:10px; right:14px; background:none; border:none; color:#fff; font-size:1.5em; cursor:pointer;">×</button>
      <h2 style="margin-top:0;">Settings</h2>
      <div style="margin-bottom:16px;">
        <label>
          <input type="checkbox" id="toggle-chat" checked>
          Show Chat Panel
        </label>
      </div>
      <!-- Move Remove Streams section here -->
      <div style="margin-bottom:18px;">
        <strong>Remove Streams</strong>
        <form id="removeStreamsForm" style="max-height:180px;overflow-y:auto;margin-top:8px;margin-bottom:8px;"></form>
        <button id="removeSelectedBtn" style="background:#ff4c4c;color:#fff;border:none;padding:5px 12px;border-radius:4px;cursor:pointer;">Remove Selected</button>
      </div>
      <button id="resetBtn" onclick="resetAll()" style="
        background: #ff4c4c;
        color: #fff;
        border: none;
        padding: 7px 18px;
        cursor: pointer;
        border-radius: 4px;
        font-size: 1em;
        margin-top: 10px;
        width: 100%;
      ">Reset All Streams</button>
      <div style="color:#888; font-size:0.95em; margin-top:16px;">More settings coming soon!</div>
    </div>
  </div>
  <script src="https://player.twitch.tv/js/embed/v1.js"></script>
  <script>
    const container = document.getElementById('container');
    const streamList = document.getElementById('streamList');
    const chat = document.getElementById('chat');
    const platformSelect = document.getElementById('platformSelect');
    const channelInput = document.getElementById('channelInput');
    const streams = {};
    let activeChatChannel = null;
    const btnStates = {};
    let focusedStreamKey = null;
    let nonFocusRotationInterval = null;
    let rotationCount = 0;
    let rotationWarningTimeout = null;

    // Default streamers are all Twitch
    const defaultStreamers = [
      { channel: "b0aty", platform: "twitch" },
      { channel: "westham", platform: "twitch" },
      { channel: "lake", platform: "twitch" },
      { channel: "sick_nerd", platform: "twitch" },
      { channel: "coxie", platform: "twitch" },
      { channel: "eliop14", platform: "twitch" },
      { channel: "purespam", platform: "twitch" },
      { channel: "skillspecs", platform: "twitch" },
      { channel: "muts", platform: "twitch" },
      { channel: "ditterbitter", platform: "twitch" },
      { channel: "sparcmac", platform: "twitch" },
      { channel: "dino_xx", platform: "twitch" },
      { channel: "mmorpg", platform: "twitch" },
      { channel: "purpp", platform: "twitch" },
      { channel: "verf", platform: "twitch" },
      { channel: "rhys", platform: "twitch" },
      { channel: "vthevictim", platform: "twitch" },
      { channel: "skiddler", platform: "twitch" },
      { channel: "evscape", platform: "twitch" },
      { channel: "dubiedobies", platform: "twitch" },
      { channel: "mikars", platform: "twitch" },
      { channel: "raikesy", platform: "twitch" },
      { channel: "pip_osrs", platform: "twitch" },
      { channel: "torvesta", platform: "twitch" },
      { channel: "odablock", platform: "twitch" },
      { channel: "solomission", platform: "twitch" },
      { channel: "mr_mammal", platform: "twitch" },
      { channel: "alfie", platform: "twitch" },
      { channel: "c_engineer", platform: "twitch" },
      // Add pip (YouTube)
      { channel: "8GfWQ18tgCw", platform: "youtube", label: "pip" },
      // Add westham (YouTube)
      { channel: "IQhHl1l_7QY", platform: "youtube", label: "westham" },
      // Add verf (YouTube)
      { channel: "C-sEPfnYnJI", platform: "youtube", label: "verf" },
      // Add MikaRS (YouTube)
      { channel: "_K-emzxOtI4", platform: "youtube", label: "MikaRS" },
      // Add PureSpam (YouTube)
      { channel: "88SQ_wWUM9c", platform: "youtube", label: "PureSpam" },
      // Add odablock and b0aty for Kick
      { channel: "odablock", platform: "kick" },
      { channel: "b0aty", platform: "kick" }
    ];

    // Add default streamers
    defaultStreamers.forEach(obj => {
      addToSidebar(obj.channel, obj.platform, obj.label);
    });
    updateFolderCounts(); // <-- Add this line

    // Use form submit instead of keypress
    document.getElementById('addForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const channel = channelInput.value.trim();
      const platform = platformSelect.value;
      const key = `${platform}:${channel.toLowerCase()}`;
      if (channel && !btnStates[key]) {
        addToSidebar(channel, platform);
        addStream(channel, platform); // Auto-add the stream!
        channelInput.value = '';
        updateEmptyPlaceholder();
        saveUserStreams(); // <-- Add this line
      }
    });

    platformSelect.addEventListener('change', function() {
      if (this.value === 'twitch' || this.value === 'kick') {
        channelInput.placeholder = 'Channel Name';
      } else if (this.value === 'youtube') {
        channelInput.placeholder = 'YouTube Video ID';
      }
    });

    // Set initial placeholder on page load
    if (platformSelect.value === 'twitch' || platformSelect.value === 'kick') {
      channelInput.placeholder = 'Channel Name';
    } else if (platformSelect.value === 'youtube') {
      channelInput.placeholder = 'YouTube Video ID';
    }

    function addToSidebar(channel, platform = 'twitch', label = null) {
      const key = `${platform}:${channel.toLowerCase()}`;
      const div = document.createElement('div');
      div.className = 'stream-item';
      div.id = `item-${key}`;

      // Platform logo SVGs
      let logo = '';
      if (platform === 'twitch') {
        logo = `<svg width="20" height="20" viewBox="0 0 40 40" style="vertical-align:middle"><rect width="40" height="40" rx="8" fill="#9147ff"/><path d="M12 10h16l2 4v12l-4 4h-6l-4 4v-4h-4z" fill="#fff"/><rect x="17" y="16" width="2" height="7" fill="#9147ff"/><rect x="21" y="16" width="2" height="7" fill="#9147ff"/></svg>`;
      } else if (platform === 'kick') {
        logo = `<svg width="20" height="20" viewBox="0 0 40 40" style="vertical-align:middle"><rect width="40" height="40" rx="8" fill="#53fc18"/><path d="M12 12h5v16h-5zm6.5 0h5v7h4v2h-4v7h-5z" fill="#181818"/></svg>`;
      } else if (platform === 'youtube') {
        logo = `<svg width="20" height="20" viewBox="0 0 40 40" style="vertical-align:middle"><rect width="40" height="40" rx="8" fill="#ff0000"/><polygon points="17,15 27,20 17,25" fill="#fff"/></svg>`;
      }

      div.innerHTML = `
        <span>${logo}<span>${label || channel}</span></span>
        <button id="add-${key}">✔️</button>
        <button id="remove-${key}">❌</button>
        <button id="chat-${key}">💬</button>
      `;

      // Always add to the platform folder first
      const platformFolder = document.getElementById(`folder-content-${platform}`) || streamList;
      platformFolder.appendChild(div);

      // If the stream is currently open, also add to "Currently Watching"
      if (btnStates[key] && btnStates[key].add) {
        // Move to "Currently Watching" folder
        const itemDiv = document.getElementById(`item-${key}`);
        const currentFolder = document.getElementById('folder-content-current');
        if (itemDiv && currentFolder && !currentFolder.contains(itemDiv)) {
          currentFolder.appendChild(itemDiv);
        }
        updateFolderCounts();
      }

      btnStates[key] = { add: false, remove: false, chat: false, platform, channel };

      document.getElementById(`add-${key}`).onclick = () => {
        addStream(channel, platform);
        updateEmptyPlaceholder();
      };
      document.getElementById(`remove-${key}`).onclick = () => {
        removeStream(channel, platform);
        updateEmptyPlaceholder();
      };
      document.getElementById(`chat-${key}`).onclick = () => setActiveChat(channel, platform);
    }

    function addStream(channel, platform = 'twitch') {
      const key = `${platform}:${channel.toLowerCase()}`;
      if (btnStates[key].add || streams[key]) return;

      const wrapper = document.createElement('div');
      wrapper.className = 'stream-wrapper';
      wrapper.id = `wrapper-${key}`;
      container.appendChild(wrapper);

      let embed;
      if (platform === 'twitch') {
        embed = new Twitch.Embed(wrapper.id, {
          width: '100%',
          height: '100%',
          channel: channel,
          parent: [location.hostname],
          layout: "video" // This hides the chat!
        });
        wrapper.embed = embed;
      } else if (platform === 'kick') {
        wrapper.classList.add('kick-stream');
        wrapper.innerHTML = `
          <iframe 
            src="https://player.kick.com/${channel}"
            width="1280"
            height="720"
            frameborder="0"
            scrolling="no"
            allowfullscreen="true"
            style="width:100%;height:100%;object-fit:contain;display:block;background:#000;">
          </iframe>
        `;
      } else if (platform === 'youtube') {
        let videoId = channel;
        const ytMatch = channel.match(/(?:v=|youtu\.be\/)([\w-]{11})/);
        if (ytMatch) videoId = ytMatch[1];
        if (/^[\w-]{11}$/.test(videoId)) {
          wrapper.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1" width="100%" height="100%" frameborder="0" allowfullscreen></iframe>`;
        } else {
          wrapper.innerHTML = `<div style="color:#fff;padding:10px;">Enter YouTube Video ID or URL</div>`;
        }
      }

      // Add a small focus button in the top-right corner
      const focusBtn = document.createElement('button');
      focusBtn.className = 'focus-btn';
      focusBtn.title = 'Focus this stream';
      focusBtn.innerHTML = '🔍';
      focusBtn.onclick = (e) => {
        setStreamFocus(key);
        e.stopPropagation();
      };
      wrapper.appendChild(focusBtn);

      streams[key] = { embed, wrapper };
      btnStates[key].add = true;
      btnStates[key].remove = false;
      updateButtonStates(channel, platform);

      // Move sidebar item to "Currently Watching"
      const itemDiv = document.getElementById(`item-${key}`);
      const currentFolder = document.getElementById('folder-content-current');
      if (itemDiv && currentFolder && !currentFolder.contains(itemDiv)) {
        currentFolder.appendChild(itemDiv);
        updateFolderCounts();
      }

      updateSingleStreamClass();
      updateEmptyPlaceholder();
    }

    function removeStream(channel, platform = 'twitch') {
      const key = `${platform}:${channel.toLowerCase()}`;
      const stream = streams[key];
      if (stream) {
        stream.wrapper.remove();
        delete streams[key];
        btnStates[key].add = false;
        btnStates[key].remove = true;
        updateButtonStates(channel, platform);
      }

      // Move sidebar item back to platform folder
      const itemDiv = document.getElementById(`item-${key}`);
      const platformFolder = document.getElementById(`folder-content-${platform}`);
      if (itemDiv && platformFolder && !platformFolder.contains(itemDiv)) {
        platformFolder.appendChild(itemDiv);
        updateFolderCounts();
      }

      updateSingleStreamClass();
      updateEmptyPlaceholder();
      updateFolderCounts();
      saveUserStreams();
    }

    function setActiveChat(channel, platform = 'twitch') {
      const key = `${platform}:${channel.toLowerCase()}`;
      const chatContent = document.getElementById('chat-content');
      const chatPanel = document.getElementById('chat');
      const chatToggle = document.getElementById('toggle-chat');
      if (activeChatChannel === key) {
        activeChatChannel = null;
        chatContent.innerHTML = '';
        chatPanel.style.display = 'none';
      } else {
        activeChatChannel = key;
        if (platform === 'twitch') {
          chatContent.innerHTML = `<iframe src="https://www.twitch.tv/embed/${channel}/chat?darkpopout&parent=${location.hostname}" width="100%" height="100%" frameborder="0"></iframe>`;
        } else if (platform === 'kick') {
          chatContent.innerHTML = `<iframe src="https://kick.com/${channel}/chatroom" width="100%" height="100%" frameborder="0"></iframe>`;
        } else if (platform === 'youtube') {
          let videoId = channel;
          const ytMatch = channel.match(/(?:v=|youtu\.be\/)([\w-]{11})/);
          if (ytMatch) videoId = ytMatch[1];
          if (/^[\w-]{11}$/.test(videoId)) {
            chatContent.innerHTML = `
              <div style="color:#fff;padding:16px 10px;">
                YouTube chat embedding is not supported directly.<br>
                <button onclick="openYouTubeChatPopout('${videoId}')" style="margin-top:10px;padding:6px 16px;background:#ff0000;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:bold;">
                  Open YouTube Chat in Popout
                </button>
              </div>
            `;
          } else {
            chatContent.innerHTML = `<div style="color:#fff;padding:10px;">YouTube chat embedding is not supported directly.</div>`;
          }
        }
        // Only show chat if toggle is enabled
        if (chatToggle && chatToggle.checked) {
          chatPanel.style.display = 'block';
        } else {
          chatPanel.style.display = 'none';
        }
      }

      Object.keys(btnStates).forEach(chKey => {
        btnStates[chKey].chat = (chKey === activeChatChannel);
        const [chPlatform, chName] = chKey.split(':');
        updateButtonStates(chName, chPlatform);
      });
    }

    function updateButtonStates(channel, platform = 'twitch') {
      const key = `${platform}:${channel.toLowerCase()}`;
      const addBtn = document.getElementById(`add-${key}`);
      const removeBtn = document.getElementById(`remove-${key}`);
      const chatBtn = document.getElementById(`chat-${key}`);

      if (!addBtn || !removeBtn || !chatBtn) return;

      addBtn.classList.toggle('active', btnStates[key].add);
      removeBtn.classList.toggle('active', btnStates[key].remove);
      chatBtn.classList.toggle('active', btnStates[key].chat);

      addBtn.disabled = btnStates[key].add;
      removeBtn.disabled = btnStates[key].remove;
    }

    document.getElementById('removeSelectedBtn').onclick = function() {
      const checked = document.querySelectorAll('#removeStreamsForm input[name="removeStream"]:checked');
      checked.forEach(box => {
        const [platform, channel] = box.value.split(':');
        removeStream(channel, platform);
      });
      populateRemoveStreamsChecklist(); // Refresh the list
      updateEmptyPlaceholder();
      updateFolderCounts();
      saveUserStreams();
    };

    function resetAll() {
      Object.keys(streams).forEach(key => {
        const [platform, channel] = key.split(':');
        removeStream(channel, platform);
      });
      activeChatChannel = null;
      document.getElementById('chat-content').innerHTML = '';

      Object.keys(btnStates).forEach(key => {
        btnStates[key] = { add: false, remove: false, chat: false, platform: btnStates[key].platform, channel: btnStates[key].channel };
        const [platform, channel] = key.split(':');
        updateButtonStates(channel, platform);
      });
      updateEmptyPlaceholder();
      updateFolderCounts();
      saveUserStreams(); // <-- Add this line
    }

    function setStreamFocus(key) {
      // Remove focus from all streams first
      Object.values(streams).forEach(obj => {
        obj.wrapper.classList.remove('focused');
      });

      // Toggle focus: if already focused, unfocus; otherwise, focus only this one
      if (focusedStreamKey === key) {
        focusedStreamKey = null;
      } else {
        focusedStreamKey = key;
        streams[key].wrapper.classList.add('focused');
        // Move the focused stream to the top
        if (container.firstChild !== streams[key].wrapper) {
          container.insertBefore(streams[key].wrapper, container.firstChild);
        }
        // Show the warning if there are at least 2 streams
        if (Object.keys(streams).length > 1) {
          showRotationWarning();
        }
      }
      updateStreamFocus();
    }

    function updateStreamFocus() {
      Object.keys(streams).forEach(key => {
        const wrapper = streams[key].wrapper;
        // Remove focus class from all
        wrapper.classList.remove('focused');
        // Always mute all streams by default
        const iframe = wrapper.querySelector('iframe');
        if (iframe) iframe.muted = true;
        if (streams[key].embed && streams[key].embed.setMuted) streams[key].embed.setMuted(true);
        if (streams[key].embed && streams[key].embed.setVolume) streams[key].embed.setVolume(1);
      });

      if (focusedStreamKey) {
        const focused = streams[focusedStreamKey];
        if (focused) {
          focused.wrapper.classList.add('focused');
          // Unmute and set volume for focused stream
          const iframe = focused.wrapper.querySelector('iframe');
          if (iframe) iframe.muted = false;
          if (focused.embed && focused.embed.setMuted) focused.embed.setMuted(false);
          if (focused.embed && focused.embed.setVolume) focused.embed.setVolume(0.5); // Set focused to 50%
        }
      }
    }

    function updateSingleStreamClass() {
      const wrappers = container.querySelectorAll('.stream-wrapper');
      wrappers.forEach(w => w.classList.remove('single'));
      if (wrappers.length === 1) {
        wrappers[0].classList.add('single');
      }
    }

    document.getElementById('settings-btn').onclick = () => {
      document.getElementById('settings-modal').style.display = 'flex';
      populateRemoveStreamsChecklist(); // <-- Add this line
    };

    document.getElementById('close-settings').onclick = () => {
      document.getElementById('settings-modal').style.display = 'none';
    };

    document.getElementById('toggle-chat').onchange = function() {
      const isChecked = this.checked;
      const chatPanel = document.getElementById('chat');
      if (!isChecked) {
        chatPanel.style.display = 'none';
      } else if (activeChatChannel) {
        chatPanel.style.display = 'block';
      }
    };

    function updateEmptyPlaceholder() {
      const placeholder = document.getElementById('empty-placeholder');
      const hasStreams = Object.keys(streams).length > 0;
      placeholder.style.display = hasStreams ? 'none' : 'flex';
    }

    // Initial call to show placeholder if no streams
    updateEmptyPlaceholder();

    function toggleFolder(platform) {
      const content = document.getElementById(`folder-content-${platform}`);
      const header = document.querySelector(`#folder-${platform} .folder-header`);
      if (content.style.display === 'none') {
        content.style.display = 'block';
        header.textContent = header.textContent.replace('►', '▼');
      } else {
        content.style.display = 'none';
        header.textContent = header.textContent.replace('▼', '►');
      }
    }

    function updateFolderCounts() {
      const platforms = ['current', 'youtube', 'kick', 'twitch'];
      platforms.forEach(platform => {
        const content = document.getElementById(`folder-content-${platform}`);
        const header = document.querySelector(`#folder-${platform} .folder-header`);
        const count = content ? content.children.length : 0;
        // Keep arrow direction
        const arrow = header.textContent.includes('►') ? '►' : '▼';
        header.textContent = `${capitalize(platform)} (${count} stream${count === 1 ? '' : 's'}) ${arrow}`;
      });
    }

    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function saveUserStreams() {
      // Only save user-added streams (not default ones)
      const userStreams = [];
      Object.keys(btnStates).forEach(key => {
        // Only save if the stream was added by the user (add is true)
        if (btnStates[key].add) {
          const { platform, channel } = btnStates[key];
          // Optionally save label if you use it
          userStreams.push({ platform, channel });
        }
      });
      localStorage.setItem('userStreams', JSON.stringify(userStreams));
    }

    window.addEventListener('DOMContentLoaded', () => {
      // Load user streams
      const saved = localStorage.getItem('userStreams');
      if (saved) {
        try {
          const userStreams = JSON.parse(saved);
          userStreams.forEach(obj => {
            addToSidebar(obj.channel, obj.platform, obj.label);
            addStream(obj.channel, obj.platform);
          });
        } catch (e) {
          // Ignore parse errors
        }
      }

      // Collapse all folders except "current"
      ['youtube', 'kick', 'twitch'].forEach(platform => {
        const content = document.getElementById(`folder-content-${platform}`);
        const header = document.querySelector(`#folder-${platform} .folder-header`);
        if (content && header) {
          content.style.display = 'none';
          header.textContent = header.textContent.replace('▼', '►');
        }
      });
      // Make sure "Currently Watching" is open
      const currentContent = document.getElementById('folder-content-current');
      const currentHeader = document.querySelector('#folder-current .folder-header');
      if (currentContent && currentHeader) {
        currentContent.style.display = 'block';
        currentHeader.textContent = currentHeader.textContent.replace('►', '▼');
      }

      // Show/hide chat panel based on checkbox state at startup
      const chatToggle = document.getElementById('toggle-chat');
      const chatPanel = document.getElementById('chat');
      if (chatToggle && chatPanel) {
        if (!chatToggle.checked) {
          chatPanel.style.display = 'none';
        } else if (activeChatChannel) {
          chatPanel.style.display = 'block';
        }
      }
    });

    function populateRemoveStreamsChecklist() {
      const form = document.getElementById('removeStreamsForm');
      form.innerHTML = '';
      Object.keys(btnStates).forEach(key => {
        if (btnStates[key].add) {
          const { platform, channel } = btnStates[key];
          const label = document.createElement('label');
          label.style.display = 'block';
          label.style.marginBottom = '4px';
          label.innerHTML = `
            <input type="checkbox" name="removeStream" value="${platform}:${channel}">
            ${capitalize(platform)}: ${channel}
          `;
          form.appendChild(label);
        }
      });
    }

    function startNonFocusRotation(intervalMs = 300000) { // 5 minutes default
      if (nonFocusRotationInterval) clearInterval(nonFocusRotationInterval);
      rotationCount = 0; // Reset on start

      nonFocusRotationInterval = setInterval(() => {
        // Only rotate if there is a focused stream
        if (!focusedStreamKey) return;

        // Get all stream keys except the focused one
        const keys = Object.keys(streams).filter(k => k !== focusedStreamKey);
        if (keys.length < 2) return; // Nothing to rotate

        // Get wrappers for non-focused streams
        const wrappers = keys.map(k => streams[k].wrapper);
        // Remove all non-focused wrappers from container
        wrappers.forEach(w => container.removeChild(w));
        // Rotate array: move first to end
        wrappers.push(wrappers.shift());
        // Insert after focused stream (or at the top if none focused)
        let insertAfter = focusedStreamKey ? streams[focusedStreamKey].wrapper : null;
        wrappers.forEach(w => {
          if (insertAfter && container.contains(insertAfter)) {
            container.insertBefore(w, insertAfter.nextSibling);
            insertAfter = w;
          } else {
            container.appendChild(w);
          }
        });

        // Show warning every 5th rotation, otherwise do nothing
        rotationCount++;
        if (rotationCount % 5 === 0) {
          showRotationWarning();
        }
      }, intervalMs);

      // Show warning on first start
      showRotationWarning();
    }

    function stopNonFocusRotation() {
      if (nonFocusRotationInterval) clearInterval(nonFocusRotationInterval);
      nonFocusRotationInterval = null;
      hideRotationWarning();
    }

    // Start rotation after adding/removing/focusing streams
    function restartNonFocusRotation() {
      stopNonFocusRotation();
      if (Object.keys(streams).length > 2) {
        startNonFocusRotation();
        showRotationWarning();
      } else {
        hideRotationWarning();
      }
    }

    // Call after relevant actions:
    const origAddStream = addStream;
    addStream = function(channel, platform = 'twitch') {
      origAddStream(channel, platform);
      restartNonFocusRotation();
    };

    const origRemoveStream = removeStream;
    removeStream = function(channel, platform = 'twitch') {
      origRemoveStream(channel, platform);
      restartNonFocusRotation();
    };

    const origSetStreamFocus = setStreamFocus;
    setStreamFocus = function(key) {
      origSetStreamFocus(key);
      restartNonFocusRotation();
    };

    // Also stop rotation on resetAll
    const origResetAll = resetAll;
    resetAll = function() {
      origResetAll();
      stopNonFocusRotation();
    };

    // Start rotation on initial load if needed
    window.addEventListener('DOMContentLoaded', () => {
      if (Object.keys(streams).length > 2) startNonFocusRotation();
    });

    function showRotationWarning() {
      const warning = document.getElementById('rotation-warning');
      warning.classList.add('visible');
      if (rotationWarningTimeout) clearTimeout(rotationWarningTimeout);
      // Fade out after 120 seconds (2 minutes)
      rotationWarningTimeout = setTimeout(() => {
        warning.classList.remove('visible');
      }, 120000);
    }
    function hideRotationWarning() {
      const warning = document.getElementById('rotation-warning');
      warning.classList.remove('visible');
      if (rotationWarningTimeout) clearTimeout(rotationWarningTimeout);
    }

    function openYouTubeChatPopout(videoId) {
      const url = `https://www.youtube.com/live_chat?v=${videoId}`;
      const width = 420;
      const height = 600;
      const left = window.screenX + (window.outerWidth - width) / 2;
      const top = window.screenY + (window.outerHeight - height) / 2;
      window.open(
        url,
        'ytChatPopout',
        `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
      );
    }
  </script>
</body>
</html>