<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MultiStream Grid</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%239146ff'><path d='M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 0h8v8h-8v-8z'/></svg>">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --sidebar-width: 280px;
            --twitch-purple: #9146ff;
            --kick-green: #53fc18;
            --yt-red: #ff0000;
            --bg-dark: #0e0e10;
            --panel-bg: #18181b;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: white;
            display: flex;
            height: 100vh; width: 100vw;
            overflow: hidden;
        }

        /* --- Sidebar --- */
        .sidebar { 
            width: var(--sidebar-width); 
            background: var(--panel-bg); 
            display: flex; 
            flex-direction: column; 
            border-right: 1px solid #2d2d30; 
            z-index: 100; 
            position: relative;
            transition: width 0.3s ease;
        }
        
        .sidebar.collapsed { width: 0; }
        .sidebar.collapsed > *:not(#sidebar-toggle) { display: none; }

        #sidebar-toggle {
            position: absolute; right: -12px; top: 50%; transform: translateY(-50%);
            width: 24px; height: 50px; background: var(--panel-bg);
            border: 1px solid #2d2d30; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 1000; color: #888;
        }

        .logo-header { padding: 30px 20px 15px 20px; display: flex; align-items: center; gap: 15px; }
        .grid-icon-logo { display: grid; grid-template-columns: 1fr 1fr; gap: 3px; width: 32px; height: 32px; flex-shrink: 0; }
        .grid-box { background: var(--twitch-purple); border-radius: 2px; box-shadow: 0 0 12px rgba(145, 70, 255, 0.6); }
        .logo-text-stack { display: flex; flex-direction: column; align-items: center; }
        .logo-main-text { font-size: 1.3rem; font-weight: 900; line-height: 0.9; color: #fff; letter-spacing: -0.5px; }
        .logo-main-text span { color: var(--twitch-purple); }
        .logo-sub-text { font-size: 0.7rem; font-weight: 800; letter-spacing: 6px; color: #888; margin-top: 4px; text-indent: 6px; }

        .search-container { position: relative; padding: 15px; border-bottom: 1px solid #2d2d30; z-index: 1001; }
        input { 
            width: 100%; padding: 12px; border-radius: 6px; border: 1px solid #333; 
            background: #26262c; color: white; outline: none; box-sizing: border-box;
            transition: all 0.3s ease;
        }
        input:focus { border-color: var(--twitch-purple); box-shadow: 0 0 15px rgba(145, 70, 255, 0.4); }

        #suggestions-box { 
            position: absolute; top: 62px; left: 15px; right: 15px; 
            background: #1f1f23; border: 1px solid #333; 
            display: none; z-index: 1000; border-radius: 8px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.8); overflow: hidden;
        }
        .suggestion-item { padding: 12px; cursor: pointer; font-size: 0.85rem; border-bottom: 1px solid #2d2d30; display: flex; justify-content: space-between; align-items: center; color: #efeff1; }
        .suggestion-item.highlighted { background: #3a3a3d; border-left: 4px solid var(--twitch-purple); }
        .label-twitch { color: var(--twitch-purple); font-weight: 800; }
        .label-kick { color: var(--kick-green); font-weight: 800; }
        .label-youtube { color: var(--yt-red); font-weight: 800; }

        .sidebar-scroll-area { flex-grow: 1; overflow-y: auto; padding: 15px; }
        .watching-item { 
            background: #26262c; padding: 12px; border-radius: 8px; margin-bottom: 8px; 
            display: flex; align-items: center; border: 1px solid transparent; 
            transition: all 0.2s; cursor: grab; 
        }
        .watching-item.twitch { border-left: 4px solid var(--twitch-purple); box-shadow: inset 4px 0 10px rgba(145, 70, 255, 0.2); }
        .watching-item.kick { border-left: 4px solid var(--kick-green); box-shadow: inset 4px 0 10px rgba(83, 252, 24, 0.2); }
        .watching-item.youtube { border-left: 4px solid var(--yt-red); box-shadow: inset 4px 0 10px rgba(255, 0, 0, 0.2); }

        main { flex-grow: 1; display: flex; overflow: hidden; background: #000; }
        #stream-container { 
            flex-grow: 1; display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(480px, 1fr)); 
            grid-auto-rows: min-content;
            gap: 20px; padding: 20px; overflow-y: auto; align-content: start; 
        }

        .stream-box { 
            position: relative; width: 100%; aspect-ratio: 16 / 9; 
            background: #111; border-radius: 12px; overflow: hidden;
            border: 2px solid transparent;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .stream-box.twitch { border-color: rgba(145, 70, 255, 0.4); box-shadow: 0 0 20px rgba(145, 70, 255, 0.3); }
        .stream-box.kick { border-color: rgba(83, 252, 24, 0.4); box-shadow: 0 0 20px rgba(83, 252, 24, 0.3); }
        .stream-box.youtube { border-color: rgba(255, 0, 0, 0.4); box-shadow: 0 0 20px rgba(255, 0, 0, 0.3); }

        .stream-box.focused-stream { grid-column: 1 / -1; max-height: 85vh; width: 100%; margin: 0 auto; box-shadow: 0 0 40px rgba(145, 70, 255, 0.5); border-color: var(--twitch-purple); }
        iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }

        .sidebar-footer { padding: 15px; border-top: 1px solid #2d2d30; background: var(--panel-bg); }
        .footer-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
        .footer-btn { padding: 10px; border-radius: 6px; border: 1px solid #333; background: #26262c; color: #ccc; cursor: pointer; font-size: 0.7rem; transition: background 0.2s; }
        .footer-btn:hover { background: #3a3a3d; }
        .copyright { opacity: 0.3; font-size: 0.65rem; text-align: center; margin: 0; }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div id="sidebar-toggle" onclick="toggleSidebar()"><span>‚Äπ</span></div>
        <div class="logo-header">
            <div class="grid-icon-logo"><div class="grid-box"></div><div class="grid-box"></div><div class="grid-box"></div><div class="grid-box"></div></div>
            <div class="logo-text-stack"><div class="logo-main-text">Multi<span>Stream</span></div><div class="logo-sub-text">GRID</div></div>
        </div>
        <div class="search-container">
            <input type="text" id="streamer-input" placeholder="Search Streamer..." autocomplete="off">
            <div id="suggestions-box"></div>
        </div>
        <div class="sidebar-scroll-area"><ul id="watching-list" style="list-style:none; padding:0; margin:0;"></ul></div>
        <footer class="sidebar-footer">
            <div class="footer-grid">
                <button class="footer-btn" onclick="toggleLayoutMode()">üñ•Ô∏è Layout</button>
                <button class="footer-btn" onclick="clearAll()">üóëÔ∏è Clear</button>
                <button class="footer-btn" onclick="showToast('Settings Saved!')">‚öôÔ∏è Settings</button>
                <button class="footer-btn" onclick="copyShareLink()">üîó Share</button>
            </div>
            <p class="copyright">¬© <span id="year"></span> MultiStream Grid.</p>
        </footer>
    </aside>
    <main><div id="stream-container"></div></main>

    <script>
        let isGridMode = false;
        let selectedIndex = -1;
        const input = document.getElementById('streamer-input');
        const suggestBox = document.getElementById('suggestions-box');

        // Notification system
        function showToast(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed; bottom: 20px; right: 20px;
                background: var(--twitch-purple); color: white;
                padding: 12px 24px; border-radius: 8px;
                font-weight: bold; z-index: 9999;
                box-shadow: 0 4px 15px rgba(0,0,0,0.5);
                transition: opacity 0.3s ease;
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }

        // Save state to LocalStorage and update dynamic URL
        function saveState() {
            const streams = Array.from(document.querySelectorAll('.watching-item')).map(li => {
                const parts = li.id.replace('list-', '').split('-');
                return { platform: parts[0], name: parts[1] };
            });
            localStorage.setItem('msGrid_streams', JSON.stringify(streams));
            localStorage.setItem('msGrid_mode', isGridMode);

            // Create compressed URL parameter for up to 150 streamers
            if (streams.length > 0) {
                const rawString = streams.map(s => `${s.platform}:${s.name}`).join(',');
                const encoded = btoa(rawString); 
                window.history.replaceState(null, '', `?g=${encoded}`);
            } else {
                window.history.replaceState(null, '', window.location.pathname);
            }
        }

        // Handle the Share button
        function copyShareLink() {
            navigator.clipboard.writeText(window.location.href).then(() => {
                showToast('üöÄ Link Copied to Clipboard!');
            }).catch(err => {
                console.error('Failed to copy link: ', err);
            });
        }

        // Load state from URL first (share links), then fall back to LocalStorage
        function loadState() {
            const params = new URLSearchParams(window.location.search);
            const encodedData = params.get('g');
            let streamsToLoad = [];

            if (encodedData) {
                try {
                    const decoded = atob(encodedData);
                    streamsToLoad = decoded.split(',').map(item => {
                        const [platform, name] = item.split(':');
                        return { platform, name };
                    });
                } catch (e) {
                    console.error("Invalid share link format.");
                    streamsToLoad = JSON.parse(localStorage.getItem('msGrid_streams') || '[]');
                }
            } else {
                streamsToLoad = JSON.parse(localStorage.getItem('msGrid_streams') || '[]');
            }

            isGridMode = (localStorage.getItem('msGrid_mode') === 'true');
            streamsToLoad.forEach(s => createStreamUI(s.name, s.platform, false));
            setTimeout(updateLayout, 50);
        }

        function toggleSidebar() { document.querySelector('.sidebar').classList.toggle('collapsed'); setTimeout(updateLayout, 300); }
        function toggleLayoutMode() { isGridMode = !isGridMode; saveState(); updateLayout(); }
        function clearAll() { document.getElementById('watching-list').innerHTML = ''; document.getElementById('stream-container').innerHTML = ''; saveState(); }

        input.addEventListener('input', () => {
            const val = input.value.trim();
            suggestBox.innerHTML = ''; selectedIndex = -1;
            if (!val) { suggestBox.style.display = 'none'; return; }
            ['twitch', 'kick', 'youtube'].forEach(p => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerHTML = `<span>Add <strong>${val}</strong></span><span class="label-${p}">${p.toUpperCase()}</span>`;
                div.onclick = () => { createStreamUI(val, p); input.value = ''; suggestBox.style.display = 'none'; };
                suggestBox.appendChild(div);
            });
            suggestBox.style.display = 'block';
        });

        input.addEventListener('keydown', (e) => {
            const items = suggestBox.querySelectorAll('.suggestion-item');
            if (e.key === 'ArrowDown') { selectedIndex = (selectedIndex + 1) % items.length; updateHighlight(items); e.preventDefault(); }
            else if (e.key === 'ArrowUp') { selectedIndex = (selectedIndex - 1 + items.length) % items.length; updateHighlight(items); e.preventDefault(); }
            else if (e.key === 'Enter') { if (selectedIndex > -1) items[selectedIndex].click(); }
        });

        function updateHighlight(items) { items.forEach((item, index) => item.classList.toggle('highlighted', index === selectedIndex)); }

        function createStreamUI(name, platform, shouldSave = true) {
            const id = `${platform}-${name.toLowerCase()}`;
            if (document.getElementById('grid-' + id)) return;
            const li = document.createElement('li');
            li.className = `watching-item ${platform}`;
            li.id = 'list-' + id;
            let logoSVG = '';
            if (platform === 'twitch') logoSVG = `<svg width="14" height="14" viewBox="0 0 24 24" fill="#9146ff" style="margin-right:12px;"><path d="M11.571 4.714h1.715v5.143H11.57zm4.715 0H18v5.143h-1.714zM6 0L1.714 4.286v15.428h5.143V24l4.286-4.286h3.428L22.286 12V0zm14.571 11.143l-3.428 3.428h-3.429l-3 3v-3H6.857V1.714h13.714Z"/></svg>`;
            else if (platform === 'kick') logoSVG = `<svg width="14" height="14" viewBox="0 0 24 24" fill="#53fc18" style="margin-right:12px;"><path d="M3 0h6v6h3V3h3V0h6v9h-3v3h3v9h-6v-3h-3v3h-3v3H3V0z"/></svg>`;
            else if (platform === 'youtube') logoSVG = `<svg width="14" height="14" viewBox="0 0 24 24" fill="#ff0000" style="margin-right:12px;"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>`;
            li.innerHTML = `${logoSVG}<span style="flex-grow:1; font-size:0.9rem;">${name}</span><span onclick="removeStream('${id}')" style="cursor:pointer; opacity:0.5;">‚úï</span>`;
            document.getElementById('watching-list').appendChild(li);
            const box = document.createElement('div');
            box.className = `stream-box ${platform}`; box.id = 'grid-' + id;
            document.getElementById('stream-container').appendChild(box);
            if (shouldSave) saveState();
            updateLayout();
        }

        function removeStream(id) { document.getElementById('list-' + id).remove(); document.getElementById('grid-' + id).remove(); saveState(); updateLayout(); }

        function updateLayout() {
            const boxes = document.querySelectorAll('.stream-box');
            boxes.forEach((box, index) => {
                const isFirst = index === 0;
                box.classList.toggle('focused-stream', !isGridMode && isFirst);
                
                const [platform, name] = box.id.replace('grid-', '').split('-');
                box.classList.remove('twitch', 'kick', 'youtube');
                box.classList.add(platform);

                let src = '';
                if (platform === 'twitch') src = `https://player.twitch.tv/?channel=${name}&parent=${window.location.hostname}&autoplay=true&muted=${!isFirst}`;
                else if (platform === 'kick') src = `https://player.kick.com/${name}?autoplay=true&muted=${!isFirst}`;
                else if (platform === 'youtube') src = `https://www.youtube.com/embed/${name}?autoplay=1&mute=${isFirst ? '0' : '1'}`;
                const currentIframe = box.querySelector('iframe');
                if (!currentIframe || currentIframe.src !== src) { box.innerHTML = `<iframe src="${src}" allowfullscreen="true"></iframe>`; }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('year').textContent = new Date().getFullYear();
            loadState();
            Sortable.create(document.getElementById('watching-list'), { 
                animation: 150, 
                onEnd: () => { 
                    saveState(); 
                    updateLayout(); 
                } 
            });
        });
    </script>
</body>
</html>
