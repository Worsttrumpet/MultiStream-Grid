<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>MultiStream Grid</title>
<style>
  body {
    background-color: #121212;
    color: #fff;
    font-family: sans-serif;
    margin: 0;
    display: flex;
    flex-direction: column;
    height: 100vh;
    min-height: 0;
    min-width: 0;
    overflow: hidden;
    gap: 0;
  }
  body {
  overflow-x: hidden;
}
  #sidebar {
  display: flex;
  flex-direction: column;
  position: relative;
  min-height: 0;
  padding: 0 0 0 0; /* Remove all padding */
  border-right: 2px solid #9147ff;
  flex: 0 0 320px; /* or your desired sidebar width */
  background: transparent;
}

  /* Add padding to the stream list container */
  #streamList {
    flex: 1 1 auto;
    overflow-y: auto;
    min-height: 0;
    max-height: none; /* Let flexbox handle height */
    background: #181818;
    background-image: repeating-linear-gradient(
      135deg,
      #232323 0px,
      #232323 8px,
      transparent 8px,
      transparent 16px
    );
    padding-right: 12px;
  }
  #container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 10px;
  padding-top: 12px;
  margin-top: 12px;
  min-width: 0;
  min-height: 0;
  background-color: #111;
  background-size: 60px 52px;
  overflow-y: auto;
  overflow-x: hidden;
  flex: 1 1 0;
  max-height: calc(100vh - 6px - 48px); /* 6px top header, 48px footer */
}

  #chat {
  display: flex;
  flex-direction: column;
  width: 320px;
  max-width: 360px;
  min-width: 220px;
  background: #181818;
  background-image: repeating-linear-gradient(
    135deg,
    #232323 0px,
    #232323 8px,
    transparent 8px,
    transparent 16px
  );
  box-sizing: border-box;
  min-height: 0;
  overflow: hidden;
  padding: 0;
  border-left: 2px solid #9147ff;
  flex: 0 0 auto;
}

#chat-header {
  flex: 0 0 auto;
  font-weight: bold;
  font-size: 1.2em;
  text-align: center;
  color: #bbb;
  letter-spacing: 1px;
  background: #222;
  padding: 12px 0 10px 0;
  border-bottom: 2px solid #333;
  border-radius: 6px 6px 0 0;
  box-shadow: 0 2px 6px #0002;
  margin: 0;
}

#chat-content {
  flex: 1 1 auto;
  min-height: 0 !important;
  height: 100%;
  display: flex;
  flex-direction: column;
  margin: 0;
  padding: 0;
  overflow-y: auto;
  overflow-x: hidden;
  position: relative;
}

#chat-content iframe {
  flex: 1 1 auto;
  width: 100%;
  height: 100%;
  min-height: 0;
  min-width: 0;
  border: none;
  display: block;
  background: #181818;
}

/* Add left padding to each stream item for extra space */
.stream-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 0 6px 6px;
    border-bottom: 1px solid #232323;
    background: transparent;
    min-height: 36px;
    position: relative;
    width: 100%;
    min-width: 0;
    cursor: pointer;
  }
  .stream-item:last-child {
    border-bottom: none;
  }
  .stream-item span {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 8px;
    word-break: break-all;
  }
  .stream-item button {
  cursor: pointer;
  background: #333;
  border: none;
  color: #fff;
  padding: 2px 5px;
  border-radius: 4px;
  transition: background 0.15s, border 0.15s;
  pointer-events: auto;
}

.stream-item button:hover {
  background: #555;
}

.stream-item button.active {
  background: #444;
  color: #fff;
  border: 1px solid #888;
}
  #controls {
    margin-bottom: 10px;
  }
  #addForm {
    display: flex;
    gap: 5px;
    margin-bottom: 10px;
  }
  #addForm input, #addForm select {
    padding: 5px;
    box-sizing: border-box;
    border-radius: 4px;
    border: none;
  }
  #channelInput {
    flex: 2;
    min-width: 0;
  }
  #platformSelect {
    flex: 1;
    min-width: 90px;
  }
  #addBtn {
    flex: 0;
    background: #333;
    color: #fff;
    border: none;
    border-radius: 4px;
    padding: 5px 10px;
    cursor: pointer;
  }
  #addBtn:hover {
    background: #555;
  }
  #resetBtn {
    background: #ff4c4c;
    color: #fff;
    border: none;
    padding: 5px;
    cursor: pointer;
    border-radius: 4px;
    width: 100%;
  }
  #resetBtn:hover {
    background: #e03a3a;
  }
  #settings-btn {
    margin: 0;
    width: auto;
    box-shadow: 0 2px 8px #0004;
    display: flex;
    align-items: center;
    justify-content: center;
    background: none;
    border-radius: 8px;
    padding: 4px 10px;
  }
  #settings-btn:hover {
    background: #333;
  }
  #settings-footer {
    flex: 0 0 auto;
    padding: 18px 0 14px 0;
    background: linear-gradient(90deg, #232323 60%, #181818 100%);
    border-top: 2px solid #9147ff; /* Twitch purple accent */
    box-shadow: 0 -2px 12px #0006;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .settings-label {
    color: #ffb300; /* Gold accent for label */
    font-size: 1.08em;
    font-weight: 600;
    letter-spacing: 0.5px;
    padding-left: 2px;
    padding-right: 2px;
    user-select: none;
  }
  #settings-btn svg {
    min-width: 28px;
    min-height: 28px;
    max-width: 28px;
    max-height: 28px;
    margin-right: 2px;
  }
  #settings-modal {
    display: none;
    position: fixed;
    left: 0;
    top: 0;
    width: 100vw;
    height: 100vh;
    background: #000a;
    z-index: 200;
    align-items: center;
    justify-content: center;
  }
  #settings-modal > div {
    background: #222;
    color: #fff;
    padding: 32px 24px 24px 24px;
    border-radius: 12px;
    min-width: 300px;
    max-width: 90vw;
    box-shadow: 0 4px 32px #000a;
    position: relative;
  }
  #close-settings {
    position: absolute;
    top: 10px;
    right: 14px;
    background: none;
    border: none;
    color: #fff;
    font-size: 1.5em;
    cursor: pointer;
  }
  #resetBtn {
    background: #ff4c4c;
    color: #fff;
    border: none;
    padding: 7px 18px;
    cursor: pointer;
    border-radius: 4px;
    font-size: 1em;
    margin-top: 10px;
    width: 100%;
  }
  #settings-footer {
    flex: 0 0 auto;
    padding: 16px 0 10px 0;
    background: #1e1e1e;
    z-index: 10;
    margin-bottom: 0;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .focus-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  z-index: 10;
  background: linear-gradient(135deg, #181818 60%, #9147ff 100%);
  color: #fff;
  border: 2px solid #9147ff;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  font-size: 1.2em;
  cursor: pointer;
  opacity: 0.96;
  transition: background 0.2s, border 0.2s, opacity 0.2s, box-shadow 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  box-shadow: 0 2px 8px #9147ff55;
}

.focus-btn:hover {
  background: linear-gradient(135deg, #232323 60%, #b47aff 100%);
  color: #fff;
  border-color: #b47aff;
  opacity: 1;
  box-shadow: 0 0 16px 4px #9147ff88, 0 0 16px #23232388;
}
  #empty-placeholder {
    position: absolute;
    left: 260px;
    right: 0;
    top: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #bbb;
    font-size: 1.5em;
    pointer-events: none;
    z-index: 1;
    background: transparent;
  }
  .folder {
    margin-bottom: 10px;
    background: #181818;
    border-radius: 6px;
    overflow: hidden;
  }
  .folder-header {
    font-weight: bold;
    padding: 8px 12px;
    background: #232323;
    cursor: pointer;
    user-select: none;
    color: #fff;
    border-bottom: 1px solid #222;
  }
  .folder-content {
    display: flex;
    flex-direction: column;
    gap: 0; /* or gap: 4px; for spacing between items */
  }
  #rotation-warning {
  display: block;
  position: fixed;
  left: 50%;
  bottom: 18px;
  transform: translateX(-50%);
  background: #222;
  color: #ffb300;
  padding: 4px 14px;
  border-radius: 12px;
  font-size: 0.98em;
  box-shadow: 0 2px 12px #000a;
  z-index: 300;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.7s;
  max-width: 90vw;
  white-space: nowrap;
}
#rotation-warning.visible {
  opacity: 0.92;
}

/* For Webkit browsers (Chrome, Edge, Safari, Opera) */
::-webkit-scrollbar {
  width: 12px;
  background: #181818; /* Dark background */
}
::-webkit-scrollbar-thumb {
  background: #2962ff; /* Blue slider */
  border-radius: 8px;
  border: 2px solid #181818;
}
::-webkit-scrollbar-thumb:hover {
  background: #448aff; /* Lighter blue on hover */
}

/* For Firefox */
* {
  scrollbar-width: thin;
  scrollbar-color: #2962ff #181818;
}

#app-header {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 0 0 10px 0; /* Remove top/left padding */
}
#app-header svg {
  display: block;
}
.stream-wrapper {
  position: relative;
  aspect-ratio: 16 / 9;
  width: 100%;
  min-width: 0;
  min-height: 0;
  max-width: 100%;
  max-height: 100%;
  margin: 0;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* All streams, all platforms: always 16:9, centered, never stretched */
.stream-wrapper iframe,
.stream-wrapper > div {
  width: 100%;
  max-width: 100%;
  aspect-ratio: 16 / 9;
  height: auto;
  object-fit: contain;
  background: #000;
  display: block;
  border: none;
  box-sizing: border-box;
  margin: auto 0;
}

/* Focused stream: center and span grid area, keep 16:9 */
.stream-wrapper.focused {
  grid-column: 2 / 5; /* columns 2, 3, 4 */
  grid-row: 3 / 6;    /* rows 3, 4, 5 */
  z-index: 2;
  aspect-ratio: 16 / 9;
  width: 100%;
  max-width: unset;
  max-height: 100%;
  margin: 0;
  display: flex;
  align-items: stretch;
  justify-content: center;
  border: 3px solid #181818;
  box-shadow: 0 0 24px #000a;
  background: #000;
  transition: box-shadow 0.2s, border 0.2s;
}

/* Focused stream content: keep 16:9, never stretch */
.stream-wrapper.focused iframe,
.stream-wrapper.focused > div {
  width: 100%;
  max-width: 100%;
  aspect-ratio: 16 / 9;
  max-height: 100%;
  border: none;
  display: block;
  object-fit: contain;
  background: #000;
  margin: 0 auto;
  box-sizing: border-box;
}

/* Subtle platform glow for non-focused streams */
.stream-wrapper.twitch-stream {
  box-shadow: 0 0 12px 2px #9147ff88, 0 0 16px #000a;
}
.stream-wrapper.youtube-stream {
  box-shadow: 0 0 12px 2px #ff000088, 0 0 16px #000a;
}
.stream-wrapper.kick-stream {
  box-shadow: 0 0 12px 2px #53fc1888, 0 0 16px #000a;
}

/* Keep the stronger glow for focused streams */
.stream-wrapper.twitch-stream.focused {
  box-shadow: 0 0 28px 8px #9147ffee, 0 0 32px #000a;
}
.stream-wrapper.youtube-stream.focused {
  box-shadow: 0 0 28px 8px #ff0000ee, 0 0 32px #000a;
}
.stream-wrapper.kick-stream.focused {
  box-shadow: 0 0 28px 8px #53fc18ee, 0 0 32px #000a;
}

/* Remove the resize handle */
.stream-wrapper.focused .resize-handle {
  display: none !important;
}
#container, #sidebar, #chat {
  min-height: 0;
}

#main-row {
  display: flex;
  flex-direction: row;
  flex: 1 1 auto;
  min-height: 0;
  min-width: 0;
  overflow: hidden;
  /* Remove height: 100%; */
  /* Ensures it doesn't overflow the footer */
}

#container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 10px;
  padding-top: 12px;
  margin-top: 12px;
  min-width: 0;
  min-height: 0;
  background-color: #111;
  background-size: 60px 52px;
  overflow-y: auto;
  overflow-x: hidden;
  flex: 1 1 0;
  max-height: calc(100vh - 6px - 48px); /* 6px top header, 48px footer */
}
#top-header {
  height: 6px;
  width: 100%;
  background: #9147ff;
}
#main-footer {
  width: 100%;
  background: #181818;
  color: #bbb;
  text-align: center;
  padding: 10px 0 8px 0;
  font-size: 1em;
  border-top: 2px solid #232323;
  box-shadow: 0 -2px 8px #0006;
  margin-top: auto;
  z-index: 2;
}
.stream-wrapper.over {
  outline: 3px dashed #ffb300;
}
#sidebar-preview {
  pointer-events: none;
  transition: opacity 0.2s;
  opacity: 0.98;
  display:none;
  position:fixed;
  z-index:1000;
  box-shadow:0 4px 24px #000a;
  border-radius:10px;
  overflow:hidden;
  background:#000;
}

/* Subfolder styling */
.subfolder {
  margin: 6px 0 0 0;
  background: #222;
  border-radius: 5px;
  overflow: hidden;
}
.subfolder-header {
  font-weight: bold;
  padding: 7px 16px;
  background: #292929;
  cursor: pointer;
  user-select: none;
  color: #ffb300;
  border-bottom: 1px solid #232323;
  font-size: 1em;
}
.subfolder-content {
  display: flex;
  flex-direction: column;
  gap: 0;
  padding-left: 10px;
}
</style>
</head>
<body>
  <div id="top-header" style="height: 6px; width: 100%; background: #9147ff;"></div>
  <div id="main-row">
    <div id="sidebar">
  <div id="app-header" style="display:flex;align-items:center;gap:10px;padding:0 0 10px 0;">
    <!-- Phoenix/Bird SVG Logo -->
    <svg width="32" height="32" viewBox="0 0 64 64" fill="none">
      <defs>
        <linearGradient id="phoenix-gradient" x1="0" y1="0" x2="64" y2="64" gradientUnits="userSpaceOnUse">
          <stop stop-color="#ffb300"/>
          <stop offset="1" stop-color="#9147ff"/>
        </linearGradient>
      </defs>
      <!-- Body/Wing -->
      <path d="M32 56
               Q44 44 40 28
               Q52 36 56 16
               Q46 28 38 18
               Q44 10 32 8
               Q20 10 26 18
               Q18 28 8 16
               Q12 36 24 28
               Q20 44 32 56Z"
            fill="url(#phoenix-gradient)" stroke="#ffb300" stroke-width="2"/>
      <!-- Head/Beak -->
      <circle cx="32" cy="16" r="4" fill="#ffb300" stroke="#9147ff" stroke-width="1.5"/>
      <polygon points="36,15 41,13 36,17" fill="#ffb300"/>
    </svg>
    <span style="font-size:1.4em;font-weight:bold;letter-spacing:1px;color:#ffb300;">MultiStream Grid</span>
  </div>
    <div id="controls">
      <form id="addForm">
        <input type="text" id="channelInput" placeholder="Streamer/Channel/Video ID or URL" autocomplete="off" />
        <select id="platformSelect">
          <option value="twitch">Twitch</option>
          <option value="kick">Kick</option>
          <option value="youtube">YouTube</option>
        </select>
        <button type="submit" id="addBtn">Add</button>
      </form>
    </div>
    <div id="streamList">
      <div class="folder" id="folder-current">
        <div class="folder-header" onclick="toggleFolder('current')">Currently Watching (0 streams) ▼</div>
        <div class="folder-content" id="folder-content-current"></div>
      </div>
      <div class="folder" id="folder-youtube">
        <div class="folder-header" onclick="toggleFolder('youtube')">YouTube (0 streams) ▼</div>
        <div class="folder-content" id="folder-content-youtube"></div>
      </div>
      <div class="folder" id="folder-kick">
        <div class="folder-header" onclick="toggleFolder('kick')">Kick (0 streams) ▼</div>
        <div class="folder-content" id="folder-content-kick"></div>
      </div>
      <div class="folder" id="folder-twitch">
        <div class="folder-header" onclick="toggleFolder('twitch')">Twitch (0 streams) ▼</div>
        <div class="folder-content" id="folder-content-twitch"></div>
      </div>
      <div class="folder" id="folder-dmm">
        <div class="folder-header" onclick="toggleFolder('dmm')">DMM Allstars Season 2 (0 streams) ▼</div>
        <div class="folder-content" id="folder-content-dmm">
          <div class="subfolder" id="subfolder-dino">
            <div class="subfolder-header" data-label="Dino Nuggets" onclick="toggleSubfolder('dino')">Dino Nuggets ▼</div>
            <div class="subfolder-content" id="subfolder-content-dino"></div>
          </div>
          <div class="subfolder" id="subfolder-oda">
            <div class="subfolder-header" data-label="Odablock Warriors" onclick="toggleSubfolder('oda')">Odablock Warriors ▼</div>
            <div class="subfolder-content" id="subfolder-content-oda"></div>
          </div>
          <div class="subfolder" id="subfolder-solo">
            <div class="subfolder-header" data-label="Solo Mission Snakes" onclick="toggleSubfolder('solo')">Solo Mission Snakes ▼</div>
            <div class="subfolder-content" id="subfolder-content-solo"></div>
          </div>
          <div class="subfolder" id="subfolder-torv">
            <div class="subfolder-header" data-label="Torvesta Titans" onclick="toggleSubfolder('torv')">Torvesta Titans ▼</div>
            <div class="subfolder-content" id="subfolder-content-torv"></div>
          </div>
          <div class="subfolder" id="subfolder-boaty">
            <div class="subfolder-header" data-label="B0aty Brawlers" onclick="toggleSubfolder('boaty')">B0aty Brawlers ▼</div>
            <div class="subfolder-content" id="subfolder-content-boaty"></div>
          </div>
          <div class="subfolder" id="subfolder-skillspecs">
            <div class="subfolder-header" data-label="Skill Spec Smorcs" onclick="toggleSubfolder('skillspecs')">Skill Spec Smorcs ▼</div>
            <div class="subfolder-content" id="subfolder-content-skillspecs"></div>
          </div>
        </div>
      </div>
    </div>
    <div id="settings-footer">
      <div id="settings-btn" title="Settings">
        <span style="display:flex; align-items:center; gap:8px;">
          <svg width="28" height="28" viewBox="0 0 28 28" fill="none" style="display:block;">
            <circle cx="14" cy="14" r="12" stroke="#bbb" stroke-width="2.2" fill="#222"/>
            <g stroke="#bbb" stroke-width="2">
              <circle cx="14" cy="14" r="4"/>
              <path d="M14 4v3M14 21v3M4 14h3M21 14h3M7.2 7.2l2.1 2.1M18.7 18.7l2.1 2.1M7.2 20.8l2.1-2.1M18.7 9.3l2.1-2.1"/>
            </g>
          </svg>
          <span class="settings-label">Settings</span>
        </span>
      </div>
    </div>
  </div>

  <div id="rotation-warning">
  Non-focused streams are being rotated every 25 minutes.
</div>
    <div id="container"></div>
    <div id="empty-placeholder"></div>
    <div id="chat" style="display:none;">
      <div id="chat-header">Chat</div>
      <div id="chat-content"></div>
    </div>
  </div>
  <div id="main-footer">
      <!-- You can put anything here, e.g. -->
      <span style="color:#bbb;font-size:1em;">MultiStream Grid &copy; 2025</span>
    </div>
  <div id="settings-modal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:#000a; z-index:200; align-items:center; justify-content:center;">
    <div style="background:#222; color:#fff; padding:32px 24px 24px 24px; border-radius:12px; min-width:300px; max-width:90vw; box-shadow:0 4px 32px #000a; position:relative;">
      <button id="close-settings" style="position:absolute; top:10px; right:14px; background:none; border:none; color:#fff; font-size:1.5em; cursor:pointer;">×</button>
      <h2 style="margin-top:0;">Settings</h2>
      <div style="margin-bottom:16px;">
        <label>
          <input type="checkbox" id="toggle-chat" checked>
          Show Chat Panel
        </label>
      </div>
      <!-- Move Remove Streams section here -->
      <div style="margin-bottom:18px;">
        <strong>Remove Streams</strong>
        <form id="removeStreamsForm" style="max-height:180px;overflow-y:auto;margin-top:8px;margin-bottom:8px;"></form>
        <button id="removeSelectedBtn" style="background:#ff4c4c;color:#fff;border:none;padding:5px 12px;border-radius:4px;cursor:pointer;">Remove Selected</button>
      </div>
      <div style="margin-bottom:18px;">
  <label for="maxStreamsInput"><strong>Max Active Streams:</strong></label>
  <input type="number" id="maxStreamsInput" min="1" max="20" value="6" style="width:60px; margin-left:8px;">
</div>
      <button id="resetBtn" onclick="confirmDeleteAllStreams()" style="
        background: #ff4c4c;
        color: #fff;
        border: none;
        padding: 7px 18px;
        cursor: pointer;
        border-radius: 4px;
        font-size: 1em;
        margin-top: 10px;
        width: 100%;
      ">Delete All Streams</button>
      <div style="color:#888; font-size:0.95em; margin-top:16px;">More settings coming soon!</div>
    </div>
  </div>
  <!-- Place this after your #container div -->
<div id="focus-size-controls" style="display:none; align-items:center; gap:10px; margin: 12px 0 0 0; justify-content:center;">
  <label for="focus-size-slider" style="color:#fff;">Focused Player Size:</label>
  <input type="range" id="focus-size-slider" min="40" max="100" value="80" style="width:180px;">
  <span id="focus-size-value" style="color:#fff;">80%</span>
</div>
  <script src="https://player.twitch.tv/js/embed/v1.js"></script>
  <script>
const container = document.getElementById('container');
const streamList = document.getElementById('streamList');
const chat = document.getElementById('chat');
const platformSelect = document.getElementById('platformSelect');
const channelInput = document.getElementById('channelInput');
const streams = {};
let activeChatChannel = null;
const btnStates = {};
let focusedStreamKey = null;
let nonFocusRotationInterval = null;
let rotationCount = 0;
let rotationWarningTimeout = null;
let previewTimeout = null;
let currentPreviewKey = null;

// --- Helper: Safe key for IDs (no colons) ---
function makeKey(platform, channel) {
  return `${platform}__${channel.toLowerCase()}`;
}

// --- DMM Subfolder Memberships ---
const dmmSubfolders = {
  boaty:      ["b0aty","port_khazard", "dubiedobies", "pip_osrs", "pip", "evscape"],
  torv:       ["torvesta", "eliop14", "lake", "alfie", "mr_mammal"],
  solo:       ["solomission", "ditterbitter", "purespam", "vthevictim", "raikesy"],
  oda:        ["odablock", "rhys", "mikars", "muts", "mmorpg"],
  dino:       ["dino_xx", "westham", "skiddler", "coxie", "verf"],
  skillspecs: ["skillspecs", "purpp", "c_engineer", "sick_nerd", "sparcmac"]
};

// --- Default Streamers (Twitch & Kick) ---
const defaultStreamers = [
  // B0aty Brawlers
  { channel: "b0aty", platform: "twitch" },
  { channel: "b0aty", platform: "kick" },
  { channel: "port_khazard", platform: "twitch" },
  { channel: "dubiedobies", platform: "twitch" },
  { channel: "pip_osrs", platform: "twitch" }, { channel: "pip", platform: "kick" },
  { channel: "evscape", platform: "twitch" }, { channel: "evscape", platform: "kick" },

  // Torvesta Titans
  { channel: "torvesta", platform: "twitch" },
  { channel: "eliop14", platform: "twitch" },
  { channel: "lake", platform: "twitch" },
  { channel: "alfie", platform: "twitch" }, { channel: "alfie", platform: "kick" },
  { channel: "mr_mammal", platform: "twitch" },

  // Solo Mission Snakes
  { channel: "solomission", platform: "twitch" },
  { channel: "ditterbitter", platform: "twitch" }, { channel: "ditterbitter", platform: "kick" },
  { channel: "purespam", platform: "twitch" },
  { channel: "vthevictim", platform: "twitch" },
  { channel: "raikesy", platform: "twitch" }, { channel: "raikesy", platform: "kick" },

  // Odablock Warriors
  { channel: "odablock", platform: "twitch" }, { channel: "odablock", platform: "kick" },
  { channel: "rhys", platform: "twitch" }, { channel: "rhys", platform: "kick" },
  { channel: "mikars", platform: "twitch" },
  { channel: "muts", platform: "twitch" },
  { channel: "mmorpg", platform: "twitch" },

  // Dino Nuggets
  { channel: "dino_xx", platform: "twitch" },
  { channel: "westham", platform: "twitch" },
  { channel: "skiddler", platform: "twitch" }, { channel: "skiddler", platform: "kick" },
  { channel: "coxie", platform: "twitch" }, { channel: "coxie", platform: "kick" },
  { channel: "verf", platform: "twitch" },

  // Skill Spec Smorcs
  { channel: "skillspecs", platform: "twitch" }, { channel: "skillspecs", platform: "kick" },
  { channel: "purpp", platform: "twitch" },
  { channel: "c_engineer", platform: "twitch" },
  { channel: "sick_nerd", platform: "twitch" }, { channel: "sick_nerd", platform: "kick" },
  { channel: "sparcmac", platform: "twitch" }
];

// --- Add default streamers to sidebar in correct subfolders ---
defaultStreamers.forEach(obj => {
  addToSidebar(obj.channel, obj.platform, obj.label, 'dmm');
  // addStream(obj.channel, obj.platform); // <-- Comment out or remove this line
  const key = makeKey(obj.platform, obj.channel);
  if (btnStates[key]) btnStates[key].dmmOriginal = true;
});
sortAllDmmSubfolders();
updateFolderCounts();

// Restore user-added streams on page load
const savedUserStreams = JSON.parse(localStorage.getItem('userStreams') || '[]');
savedUserStreams.forEach(obj => {
  addToSidebar(obj.channel, obj.platform, obj.label);
  addStream(obj.channel, obj.platform);
});

// Use form submit instead of keypress
document.getElementById('addForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const channel = channelInput.value.trim();
  const platform = platformSelect.value;
  const key = makeKey(platform, channel);
  if (channel && !btnStates[key]) {
    addToSidebar(channel, platform);
    addStream(channel, platform);
    channelInput.value = '';
    updateEmptyPlaceholder && updateEmptyPlaceholder();
    saveUserStreams && saveUserStreams();
  }
});

platformSelect.addEventListener('change', function() {
  if (this.value === 'twitch' || this.value === 'kick') {
    channelInput.placeholder = 'Channel Name';
  } else if (this.value === 'youtube') {
    channelInput.placeholder = 'YouTube Video ID';
  }
});

// Set initial placeholder on page load
if (platformSelect.value === 'twitch' || platformSelect.value === 'kick') {
  channelInput.placeholder = 'Channel Name';
} else if (platformSelect.value === 'youtube') {
  channelInput.placeholder = 'YouTube Video ID';
}

// Add to Sidebar (with dmmOriginal support)
function addToSidebar(channel, platform = 'twitch', label = null, folder = null) {
  const key = makeKey(platform, channel);
  let div = document.getElementById(`item-${key}`);
  if (!div) {
    div = document.createElement('div');
    div.className = 'stream-item';
    div.id = `item-${key}`;

    // Platform logo SVGs
    let logo = '';
    if (platform === 'twitch') {
      logo = `<svg width="20" height="20" viewBox="0 0 40 40" style="vertical-align:middle"><rect width="40" height="40" rx="8" fill="#9147ff"/><path d="M12 10h16l2 4v12l-4 4h-6l-4 4v-4h-4z" fill="#fff"/><rect x="17" y="16" width="2" height="7" fill="#9147ff"/><rect x="21" y="16" width="2" height="7" fill="#9147ff"/></svg>`;
    } else if (platform === 'kick') {
      logo = `<svg width="20" height="20" viewBox="0 0 40 40" style="vertical-align:middle"><rect width="40" height="40" rx="8" fill="#53fc18"/><path d="M12 12h5v16h-5zm6.5 0h5v7h4v2h-4v7h-5z" fill="#181818"/></svg>`;
    } else if (platform === 'youtube') {
      logo = `<svg width="20" height="20" viewBox="0 0 40 40" style="vertical-align:middle"><rect width="40" height="40" rx="8" fill="#ff0000"/><polygon points="17,15 27,20 17,25" fill="#fff"/></svg>`;
    }

    div.innerHTML = `
      <span>${logo}<span>${label || channel}</span></span>
      <button id="add-${key}">✔️</button>
      <button id="remove-${key}">❌</button>
      <button id="chat-${key}">💬</button>
    `;

    // Add left-click to focus/add
    // div.addEventListener('click', function(e) {
    //  if (e.target.tagName === 'BUTTON') return;
    //  if (!streams[key]) {
    //    addStream(channel, platform);
    //  }
    //});

    // Place in the specified folder, or default to platform folder
    let folderContent;
    if (folder === 'dmm') {
      let placed = false;
      for (const [sub, members] of Object.entries(dmmSubfolders)) {
        if (members.includes(channel.toLowerCase())) {
          folderContent = document.getElementById(`subfolder-content-${sub}`);
          placed = true;
          break;
        }
      }
      if (!placed) folderContent = document.getElementById('folder-content-dmm');
    } else if (folder) {
      folderContent = document.getElementById(`folder-content-${folder}`);
    }
    if (!folderContent) {
      folderContent = document.getElementById(`folder-content-${platform}`) || streamList;
    }
    folderContent.appendChild(div);

    btnStates[key] = { add: false, remove: false, chat: false, platform, channel };
    if (folder === 'dmm') {
      btnStates[key].dmmOriginal = true;
    }

    // Add click listeners for new buttons
    addButtonListeners(div, key, platform, channel);

    // Sidebar preview hover effects
    div.addEventListener('mouseenter', function(e) {
      console.log('Hover detected for', channel, platform); // Add this line
      showSidebarPreview(channel, platform, e);
    });
    div.addEventListener('mouseleave', function() {
      clearSidebarPreview();
    });
  }
  updateFolderCounts();
}

function addButtonListeners(div, key, platform, channel) {
  const addButton = div.querySelector(`#add-${key}`);
  const removeButton = div.querySelector(`#remove-${key}`);
  const chatButton = div.querySelector(`#chat-${key}`);

  if (addButton) {
    addButton.addEventListener('click', function(e) {
      e.stopPropagation();
      addStream(channel, platform);
    });
  }

  if (removeButton) {
    removeButton.addEventListener('click', function(e) {
      e.stopPropagation();
      removeStream(channel, platform);
    });
  }

  if (chatButton) {
    chatButton.addEventListener('click', function(e) {
      e.stopPropagation();
      toggleChat(channel, platform);
    });
  }
}

function sortAllDmmSubfolders() {
  Object.keys(dmmSubfolders).forEach(sub => {
    const subfolder = document.getElementById(`subfolder-content-${sub}`);
    if (!subfolder) return;
    const items = Array.from(subfolder.children);
    items.sort((a, b) => {
      const aLabel = a.querySelector('span span')?.textContent?.toLowerCase() || '';
      const bLabel = b.querySelector('span span')?.textContent?.toLowerCase() || '';
      return aLabel.localeCompare(bLabel);
    });
    items.forEach(item => subfolder.appendChild(item));
  });
}

function updateFolderCounts() {
  // Reset all folder labels
  document.querySelectorAll('.folder-header').forEach(header => {
    header.innerHTML = header.innerHTML.replace(/ *\(\d+ streams\)/, '');
  });

  // Update counts for each folder
  Object.keys(streams).forEach(key => {
    const [platform, channel] = key.split('__');
    const folderId = `folder-content-${platform}`;
    const folder = document.getElementById(folderId);
    if (folder) {
      const count = folder.children.length;
      const header = folder.previousElementSibling;
      if (header) {
        header.innerHTML = header.innerHTML.replace(/ *\(\d+ streams\)/, '') + ` (${count} streams)`;
      }
    }
  });

  // Update DMM subfolder counts
  for (const [sub, members] of Object.entries(dmmSubfolders)) {
    const present = new Set();
    let count = 0;
members.forEach(member => {
  if (document.getElementById(`item-twitch__${member}`)) count++;
  if (document.getElementById(`item-kick__${member}`)) count++;
  if (document.getElementById(`item-youtube__${member}`)) count++;
});
    const subfolder = document.getElementById(`subfolder-content-${sub}`);
    if (subfolder) {
      const header = subfolder.previousElementSibling;
      if (header) {
        // Use the original label from data-label
        const label = header.getAttribute('data-label') || header.textContent.replace(/ *\(\d+\) *▼*$/, '');
        header.innerHTML = `${label} (${count}) ▼`;
      }
    }
  }
}

function addStream(channel, platform) {
  const key = makeKey(platform, channel);
  if (streams[key]) return; // Stream already exists

  streams[key] = { channel, platform };

  // Create the wrapper div
  const wrapper = document.createElement('div');
  wrapper.className = 'stream-wrapper';
  if (platform === 'twitch') wrapper.classList.add('twitch-stream');
  if (platform === 'kick') wrapper.classList.add('kick-stream');
  if (platform === 'youtube') wrapper.classList.add('youtube-stream');
  wrapper.setAttribute('data-channel', channel);
  wrapper.setAttribute('data-platform', platform);

  // --- Add the focus button ---
  const focusBtn = document.createElement('button');
  focusBtn.className = 'focus-btn';
  focusBtn.title = 'Focus this stream';
  focusBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 20 20" fill="none" style="display:block;">
  <circle cx="9" cy="9" r="7" stroke="#fff" stroke-width="2"/>
  <line x1="14.2" y1="14.2" x2="18" y2="18" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
</svg>`;
  focusBtn.onclick = (e) => {
    e.stopPropagation();
    focusStream(key);
  };
  wrapper.appendChild(focusBtn);

  // Create the iframe
  const iframe = document.createElement('iframe');
  iframe.src = getStreamUrl(channel, platform);
  iframe.allowFullscreen = true;
  iframe.setAttribute('data-channel', channel);
  iframe.setAttribute('data-platform', platform);
  // Mute by default
  iframe.muted = true;
  iframe.setAttribute('muted', ''); // For some browsers

  // Append iframe to wrapper, then wrapper to container
  wrapper.appendChild(iframe);
  container.appendChild(wrapper);

  // Update focused stream if none is set
  if (!focusedStreamKey) {
    focusedStreamKey = key;
    updateFocusStream();
  }

  // Reset rotation for this stream
  resetStreamRotation(key);

  // Update sidebar button states
  updateBtnStates(key, true);

  // Update folder counts
  updateFolderCounts();
}

function removeStream(channel, platform) {
  const key = makeKey(platform, channel);
  if (!streams[key]) return; // Stream doesn't exist

  // Remove the wrapper div
  const wrapper = container.querySelector(`.stream-wrapper[data-channel="${channel}"][data-platform="${platform}"]`);
  if (wrapper) {
    container.removeChild(wrapper);
  }

  // Remove from streams object
  delete streams[key];

  // If removing the focused stream, clear the focus
  if (focusedStreamKey === key) {
    focusedStreamKey = null;
    clearFocusStream();
  }

  // Update sidebar button states
  updateBtnStates(key, false);

  // Update folder counts
  updateFolderCounts();
}

function getStreamUrl(channel, platform) {
  let src = '';
  if (platform === 'twitch') {
    const parent = window.location.hostname;
    let parentParams = `parent=${parent}`;
    if (parent === 'localhost') parentParams += '&parent=127.0.0.1';
    if (parent === '127.0.0.1') parentParams += '&parent=localhost';
    src = `https://player.twitch.tv/?channel=${channel}&${parentParams}&autoplay=true&muted=true`;
  } else if (platform === 'kick') {
    src = `https://player.kick.com/${channel}`;
  } else if (platform === 'youtube') {
    src = `https://www.youtube.com/embed/${channel}?autoplay=1&mute=1`;
  }
  return src;
}

function toggleChat(channel, platform) {
  const key = makeKey(platform, channel);
  const chatContent = document.getElementById('chat-content');
  const chatHeader = document.getElementById('chat-header');
  const isOpen = chat.style.display === 'flex';

  // Close chat if already open
  if (isOpen) {
    chat.style.display = 'none';
    activeChatChannel = null;
    chatContent.innerHTML = '';
    return;
  }

  // Open chat for the selected stream
  chat.style.display = 'flex';
  activeChatChannel = key;

  // Load chat iframe
  const iframe = document.createElement('iframe');
  iframe.src = `https://www.twitch.tv/embed/${channel}/chat?parent=localhost&theme=dark`;
  iframe.allowFullscreen = true;
  iframe.setAttribute('data-channel', channel);
  iframe.setAttribute('data-platform', platform);
  chatContent.innerHTML = '';
  chatContent.appendChild(iframe);

  // Update chat header
  chatHeader
}

function updateFocusStream() {
  if (focusedStreamKey) {
    const [platform, channel] = focusedStreamKey.split('__');
    const iframe = container.querySelector(`iframe[data-channel="${channel}"][data-platform="${platform}"]`);
    if (iframe) {
      iframe.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }
}

function clearFocusStream() {
  // Remove .focused class and mute all streams
  container.querySelectorAll('.stream-wrapper').forEach(wrapper => {
    wrapper.classList.remove('focused');
    const iframe = wrapper.querySelector('iframe');
    if (iframe) {
      iframe.muted = true;
      iframe.setAttribute('muted', '');
    }
  });
}

function resetStreamRotation(key) {
  // Clear existing rotation timeout
  if (nonFocusRotationInterval) {
    clearInterval(nonFocusRotationInterval);
    nonFocusRotationInterval = null;
  }

  // Reset rotation count
  rotationCount = 0;

  // Hide rotation warning
  const warning = document.getElementById('rotation-warning');
  warning.classList.remove('visible');

  // If this is a focused stream, do not rotate
  if (focusedStreamKey === key) return;

  // Rotate non-focused streams every 25 minutes
  nonFocusRotationInterval = setInterval(() => {
    if (rotationCount >= 3) {
      // After 3 rotations, show warning and stop rotating
      warning.classList.add('visible');
      clearInterval(nonFocusRotationInterval);
      nonFocusRotationInterval = null;
    } else {
      // Rotate to the next non-focused stream
      rotateToNextStream();
      rotationCount++;
    }
  }, 25 * 60 * 1000); // 25 minutes
}

function rotateToNextStream() {
  const keys = Object.keys(streams);
  if (keys.length === 0) return;

  // Find the index of the current focused stream
  const currentIndex = keys.indexOf(focusedStreamKey);

  // Calculate the index of the next stream (skip focused stream)
  const nextIndex = (currentIndex + 1) % keys.length;
  const nextKey = keys[nextIndex];

  // Focus the next stream
  focusStream(nextKey);
}

function focusStream(key) {
  if (focusedStreamKey === key) {
    // If already focused, unfocus it
    focusedStreamKey = null;
    clearFocusStream();
    return;
  }

  // Clear focus from all streams and mute them
  container.querySelectorAll('.stream-wrapper').forEach(wrapper => {
    wrapper.classList.remove('focused');
    const iframe = wrapper.querySelector('iframe');
    if (iframe) {
      iframe.muted = true;
      iframe.setAttribute('muted', '');
    }
  });

  // Set the new focused stream
  focusedStreamKey = key;

  // Add .focused class to the selected stream-wrapper and unmute its iframe
  const [platform, channel] = key.split('__');
  const wrapper = container.querySelector(`.stream-wrapper[data-channel="${channel}"][data-platform="${platform}"]`);
  if (wrapper) {
    wrapper.classList.add('focused');
    const iframe = wrapper.querySelector('iframe');
    if (iframe) {
      iframe.muted = false;
      iframe.removeAttribute('muted');
    }
    wrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  // Reset rotation for the focused stream
  resetStreamRotation(key);
}

function updateBtnStates(key, isActive) {
  const btnState = btnStates[key];
  if (!btnState) return;

  // Update the add/remove/chat button states
  const addButton = document.getElementById(`add-${key}`);
  const removeButton = document.getElementById(`remove-${key}`);
  const chatButton = document.getElementById(`chat-${key}`);

  if (addButton) {
    addButton.style.display = isActive ? 'none' : 'inline-block';
  }
  if (removeButton) {
    removeButton.style.display = isActive ? 'inline-block' : 'none';
  }
  if (chatButton) {
    chatButton.style.display = isActive ? 'inline-block' : 'none';
  }
}

// Auto-focus the first stream on page load
window.addEventListener('load', () => {
  const firstKey = Object.keys(streams)[0];
  if (firstKey) {
    focusStream(firstKey);
  }
});

// Close settings modal on click
document.getElementById('close-settings').addEventListener('click', function() {
  document.getElementById('settings-modal').style.display = 'none';
});

// Open settings modal on settings button click
document.getElementById('settings-btn').addEventListener('click', function() {
  document.getElementById('settings-modal').style.display = 'flex';
});

// Toggle chat panel visibility
document.getElementById('toggle-chat').addEventListener('change', function() {
  if (this.checked) {
    chat.style.display = 'flex';
    updateFocusStream();
  } else {
    chat.style.display = 'none';
  }
});

// Handle form submission for removing streams
document.getElementById('removeStreamsForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const selected = Array.from(this.querySelectorAll('input[type="checkbox"]:checked'));
  selected.forEach(checkbox => {
    const key = checkbox.value;
    const [platform, channel] = key.split('__');
    removeStream(channel, platform);
  });
  this.reset();
});

// Update max active streams setting
document.getElementById('maxStreamsInput').addEventListener('input', function() {
  const maxStreams = Math.min(Math.max(parseInt(this.value) || 0, 1), 20);
  this.value = maxStreams;
  localStorage.setItem('maxActiveStreams', maxStreams);
});

// Show rotation warning if enabled
const rotationWarningEnabled = true; // Set to false to disable
if (rotationWarningEnabled) {
  const warning = document.getElementById('rotation-warning');
  warning.style.display = 'block';
  setTimeout(() => {
    warning.style.opacity = '0';
  }, 5000);
}

// Focus size controls
const focusSizeSlider = document.getElementById('focus-size-slider');
const focusSizeValue = document.getElementById('focus-size-value');
focusSizeSlider.addEventListener('input', function() {
  const value = this.value;
  focusSizeValue.textContent = `${value}%`;
  if (focusedStreamKey) {
    const [platform, channel] = focusedStreamKey.split('__');
    const iframe = container.querySelector(`iframe[data-channel="${channel}"][data-platform="${platform}"]`);
    if (iframe) {
      iframe.style.transform = `scale(${value / 100})`;
      iframe.style.transformOrigin = 'center center';
    }
  }
});

// Initial focus size value
focusSizeValue.textContent = `${focusSizeSlider.value}%`;

// Folder toggles
function toggleFolder(folder) {
  const content = document.getElementById(`folder-content-${folder}`);
  if (content) {
    content.style.display = content.style.display === 'none' ? '' : 'none';
  }
}
function toggleSubfolder(sub) {
  const content = document.getElementById(`subfolder-content-${sub}`);
  if (content) {
    content.style.display = content.style.display === 'none' ? '' : 'none';
  }
}

// Sidebar preview
function showSidebarPreview(channel, platform, event) {
  clearSidebarPreview();
  const previewBox = document.getElementById('sidebar-preview');
  previewTimeout = setTimeout(() => {
    let src = '';
    let boxShadow = '0 4px 24px #000a'; // default
    if (platform === 'twitch') {
      const parent = window.location.hostname;
      let parentParams = `parent=${parent}`;
      if (parent === 'localhost') parentParams += '&parent=127.0.0.1';
      if (parent === '127.0.0.1') parentParams += '&parent=localhost';
      src = `https://player.twitch.tv/?channel=${channel}&${parentParams}&autoplay=true&muted=true`;
      boxShadow = '0 0 28px 8px #9147ffee, 0 0 32px #000a'; // Twitch purple
    } else if (platform === 'kick') {
      src = `https://player.kick.com/${channel}`;
      boxShadow = '0 0 28px 8px #53fc18ee, 0 0 32px #000a'; // Kick green
    } else if (platform === 'youtube') {
      src = `https://www.youtube.com/embed/${channel}?autoplay=1&mute=1`;
      boxShadow = '0 0 28px 8px #ff0000ee, 0 0 32px #000a'; // YouTube red
    }
    previewBox.innerHTML = `<iframe src="${src}" width="320" height="180" frameborder="0" allowfullscreen style="display:block;"></iframe>`;
    previewBox.style.display = 'block';
    previewBox.style.left = (event.clientX + 20) + 'px';
    previewBox.style.top = (event.clientY - 40) + 'px';
    previewBox.style.width = '320px';
    previewBox.style.height = '180px';
    previewBox.style.background = '#111';
    previewBox.style.zIndex = 9999;
    previewBox.style.boxShadow = boxShadow; // <-- Add this line
  }, 1000);
}

function clearSidebarPreview() {
  clearTimeout(previewTimeout);
  const previewBox = document.getElementById('sidebar-preview');
  previewBox.style.display = 'none';
  previewBox.innerHTML = '';
  currentPreviewKey = null;
}
  </script>
  <div id="sidebar-preview"></div>
</body>
</html>
